<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= typeof course !== 'undefined' ? course.topic : 'Course' %> | AdaptLearn AI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/lucide-static@0.321.0/font/lucide.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #18181b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #52525b; }
        
        .prose p { margin-bottom: 1rem; color: #d4d4d8; line-height: 1.7; }
        .prose strong { color: #fff; font-weight: 600; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; color: #d4d4d8; }
        
        .prose code { background: #27272a; padding: 0.2rem 0.4rem; border-radius: 4px; color: #a5b4fc; font-family: monospace; }
        .prose pre { background: #18181b; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin-bottom: 1rem; }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-200 h-screen flex overflow-hidden font-sans selection:bg-indigo-500/30">

    <script id="lesson-data-json" type="application/json">
        <%- (typeof lesson !== 'undefined' && lesson) ? JSON.stringify(lesson) : 'null' %>
    </script>

    <aside class="w-80 border-r border-zinc-800 bg-zinc-900/50 flex flex-col hidden md:flex">
        <div class="p-6 border-b border-zinc-800">
            <a href="/dashboard" class="flex items-center text-xs text-zinc-500 hover:text-white mb-4 transition uppercase tracking-widest font-bold">
                <i class="lucide-arrow-left w-3 h-3 mr-1"></i> Dashboard
            </a>
            <h1 class="text-xl font-bold text-white leading-tight mb-1">
                <%= typeof course !== 'undefined' ? course.topic : 'Loading...' %>
            </h1>
            <div class="flex items-center space-x-2 mt-2">
                <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-zinc-800 text-zinc-400 border border-zinc-700">
                    <%= typeof course !== 'undefined' ? course.level : 'Beginner' %>
                </span>
                <span class="text-xs text-zinc-500">
                    <%= typeof course !== 'undefined' && course.syllabus ? course.syllabus.length : 0 %> Modules
                </span>
            </div>
        </div>
        
        <nav class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar">
            <% if (typeof course !== 'undefined' && course.syllabus && course.syllabus.length > 0) { %>
                <% course.syllabus.forEach((module, index) => { 
                    const isActive = (index === 0);
                    const baseClass = "cursor-pointer group p-4 rounded-xl border transition-all duration-200 module-item";
                    const activeState = "bg-indigo-500/5 border-indigo-500/30 shadow-[0_0_15px_-3px_rgba(99,102,241,0.1)]";
                    const inactiveState = "bg-zinc-900/30 border-zinc-800/50 hover:bg-zinc-800 hover:border-zinc-700";
                    const finalClass = `${baseClass} ${isActive ? activeState : inactiveState}`;
                %>
                    <div data-index="<%= index %>" class="<%= finalClass %>">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[10px] font-bold uppercase tracking-widest <%= isActive ? 'text-indigo-400' : 'text-zinc-500 group-hover:text-zinc-400' %>">
                                Module <%= index + 1 %>
                            </span>
                            <% if(isActive) { %>
                                <div class="flex h-2 w-2 relative">
                                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-2 w-2 bg-indigo-500"></span>
                                </div>
                            <% } else { %>
                                <i class="lucide-lock w-3 h-3 text-zinc-700"></i>
                            <% } %>
                        </div>
                        <h3 class="font-medium text-sm text-zinc-300 group-hover:text-white transition-colors">
                            <%= module.title %>
                        </h3>
                    </div>
                <% }) %>
            <% } else { %>
                <div class="p-4 text-center text-zinc-500 text-sm">No modules loaded.</div>
            <% } %>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col items-center justify-center relative bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-zinc-900 via-zinc-950 to-zinc-950">
        
        <div class="absolute top-0 w-full p-6 flex justify-between items-center bg-gradient-to-b from-zinc-950 to-transparent z-10">
            <span class="text-zinc-500 text-sm font-medium tracking-wide">
                Card <span id="card-index" class="text-white">1</span> <span class="text-zinc-700">/</span> <span id="card-total">--</span>
            </span>
            <div class="w-48 h-1.5 bg-zinc-900 border border-zinc-800 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.5)] transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
        </div>

        <div class="w-full max-w-3xl flex flex-col max-h-[75vh] mx-4">
            <div class="relative flex flex-col bg-zinc-900/80 backdrop-blur-xl border border-zinc-800 rounded-2xl shadow-2xl overflow-hidden ring-1 ring-white/5">
                
                <div id="card-container" class="p-8 md:p-12 overflow-y-auto custom-scrollbar">
                    <div id="card-content" class="space-y-6 min-h-[300px]">
                        <div class="flex flex-col items-center justify-center h-48 space-y-4 animate-pulse">
                            <div class="w-8 h-8 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                            <p class="text-zinc-500 text-sm">Preparing lesson...</p>
                        </div>
                    </div>
                </div>

                <div class="p-4 md:p-6 bg-zinc-900 border-t border-zinc-800 flex items-center justify-between gap-4">
                    <button onclick="prevCard()" class="px-4 py-2 text-zinc-400 hover:text-white text-sm font-medium transition flex items-center gap-2 group">
                        <i class="lucide-arrow-left w-4 h-4 group-hover:-translate-x-1 transition-transform"></i> Back
                    </button>

                    <button onclick="toggleVoice()" id="mic-btn" class="relative p-3 rounded-full bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white border border-zinc-700 transition-all active:scale-95 group">
                        <span id="mic-pulse" class="absolute inset-0 rounded-full bg-red-500/20 animate-ping hidden"></span>
                        <i class="lucide-mic w-5 h-5"></i>
                    </button>

                    <button onclick="nextCard()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-medium transition flex items-center shadow-lg shadow-indigo-500/20 hover:shadow-indigo-500/30 active:scale-95">
                        Next <i class="lucide-arrow-right w-4 h-4 ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="absolute bottom-6 w-full max-w-2xl px-4">
            <form onsubmit="askTutor(event); return false;" class="relative group">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-xl opacity-20 group-hover:opacity-40 transition duration-500 blur"></div>
                <input type="text" id="tutor-input" placeholder="Ask the AI Tutor about this card..." 
                    class="relative w-full bg-zinc-950 border border-zinc-800 rounded-xl py-3.5 px-5 pr-12 text-zinc-200 placeholder-zinc-600 focus:outline-none focus:border-indigo-500/50 focus:ring-1 focus:ring-indigo-500/20 transition shadow-xl">
                <button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 text-zinc-500 hover:text-indigo-400 transition">
                    <i class="lucide-send w-4 h-4"></i>
                </button>
            </form>
        </div>
    </main>

    <script>
        // 1. SETUP & UTILS
        mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'loose' });
        
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        } else {
            document.addEventListener('DOMContentLoaded', () => lucide.createIcons());
        }

        // --- LINTER FIX: Use Number() wrapper so VS Code doesn't complain ---
        const courseId = Number("<%= course.id %>"); 

        // 2. PARSE INITIAL DATA
        let lessonData = null;
        try {
            const rawData = document.getElementById('lesson-data-json').textContent;
            lessonData = JSON.parse(rawData);
        } catch (e) {
            console.error("Failed to parse lesson data", e);
        }

        // 3. EVENT LISTENERS
        document.querySelectorAll('.module-item').forEach(item => {
            item.addEventListener('click', function() {
                const index = this.getAttribute('data-index');
                loadModule(index);
            });
        });
        
        // State
        let currentIndex = 0;
        let isListening = false;
        let recognition = null;

        // 4. MAIN RENDER FUNCTION
        function renderCard() {
            if (!lessonData || !lessonData.cards || lessonData.cards.length === 0) {
                document.getElementById('card-content').innerHTML = `
                    <div class="text-center py-10">
                        <h3 class="text-xl font-bold text-white mb-2">Ready to Learn?</h3>
                        <p class="text-zinc-400 mb-6">Select a module from the sidebar to generate your first lesson.</p>
                    </div>
                `;
                return;
            }

            const card = lessonData.cards[currentIndex];
            const container = document.getElementById('card-content');
            
            // Update UI
            document.getElementById('card-index').innerText = currentIndex + 1;
            document.getElementById('card-total').innerText = lessonData.cards.length;
            document.getElementById('progress-bar').style.width = `${((currentIndex + 1) / lessonData.cards.length) * 100}%`;

            let html = '';

            // --- TEMPLATES ---
            if (card.type === 'text') {
                html = `
                    <div class="animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <span class="text-xs font-bold text-indigo-400 tracking-wider uppercase mb-3 block">Topic Overview</span>
                        <h2 class="text-3xl font-bold text-white mb-6 leading-tight">${lessonData.title}</h2>
                        <div class="prose prose-invert prose-lg text-zinc-300">
                            ${marked.parse(card.content)}
                        </div>
                    </div>
                `;
            } else if (card.type === 'chart') {
                html = `
                    <div class="animate-in fade-in zoom-in-95 duration-500">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i class="lucide-git-branch w-5 h-5 mr-2 text-indigo-400"></i> Visual Concept
                        </h3>
                        <div class="bg-zinc-950 border border-zinc-800 rounded-xl p-6 flex justify-center overflow-x-auto custom-scrollbar">
                            <div class="mermaid text-center">${card.content}</div>
                        </div>
                        <p class="text-center text-xs text-zinc-500 mt-4">Flowchart generated by AI</p>
                    </div>
                `;
            } else if (card.type === 'quiz') {
                html = `
                    <div class="animate-in fade-in slide-in-from-right-4 duration-500">
                        <div class="bg-indigo-500/5 border border-indigo-500/20 rounded-2xl p-6 md:p-8">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-500/10 text-indigo-400 mb-4 border border-indigo-500/20">
                                <i class="lucide-brain-circuit w-3 h-3 mr-1"></i> Quick Quiz
                            </span>
                            <h3 class="text-xl md:text-2xl font-bold text-white mb-8">${card.question}</h3>
                            <div class="space-y-3">
                                ${card.options.map(opt => `
                                    <button onclick="checkAnswer(this, '${opt.replace(/'/g, "\\'")}', '${card.answer.replace(/'/g, "\\'")}')" 
                                        class="w-full text-left p-4 rounded-xl bg-zinc-800/50 hover:bg-zinc-800 border border-zinc-700/50 hover:border-zinc-600 transition-all duration-200 flex items-center justify-between group">
                                        <span class="text-zinc-300 group-hover:text-white font-medium">${opt}</span>
                                        <div class="w-5 h-5 rounded-full border-2 border-zinc-600 group-hover:border-zinc-400 flex items-center justify-center">
                                            <div class="w-2.5 h-2.5 rounded-full bg-white opacity-0 transition-opacity check-dot"></div>
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                            <div id="feedback-msg" class="mt-6 p-4 rounded-lg hidden text-sm font-medium animate-in fade-in slide-in-from-top-2"></div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
            lucide.createIcons();

            if (card.type === 'chart') {
                setTimeout(() => {
                    mermaid.init(undefined, document.querySelectorAll('.mermaid'));
                }, 100);
            }
        }

        // 5. FETCH NEW MODULE
        async function loadModule(index) {
            const container = document.getElementById('card-content');
            const sidebarItems = document.querySelectorAll('.module-item');

            // 1. Loading UI
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-64 animate-in fade-in">
                    <div class="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <h3 class="text-xl font-bold text-white">Generating Module ${parseInt(index) + 1}...</h3>
                    <p class="text-zinc-400">The AI is crafting your lesson cards.</p>
                </div>
            `;

            // 2. Visual Updates (Sidebar)
            sidebarItems.forEach(item => {
                item.classList.remove('bg-indigo-500/5', 'border-indigo-500/30', 'shadow-[0_0_15px_-3px_rgba(99,102,241,0.1)]');
                item.classList.add('bg-zinc-900/30', 'border-zinc-800/50');
                const label = item.querySelector('span');
                if(label) label.classList.replace('text-indigo-400', 'text-zinc-500');
            });

            const activeItem = document.querySelector(`.module-item[data-index="${index}"]`);
            if (activeItem) {
                activeItem.classList.remove('bg-zinc-900/30', 'border-zinc-800/50');
                activeItem.classList.add('bg-indigo-500/5', 'border-indigo-500/30', 'shadow-[0_0_15px_-3px_rgba(99,102,241,0.1)]');
                const label = activeItem.querySelector('span');
                if(label) label.classList.replace('text-zinc-500', 'text-indigo-400');
            }

            try {
                // 3. Fetch from API
                const response = await fetch('/api/generate-lesson', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ courseId: courseId, moduleIndex: index })
                });
                const data = await response.json();

                if (data.error) throw new Error(data.error);

                // 4. Update & Render
                lessonData = data;
                currentIndex = 0;
                renderCard();

            } catch (error) {
                console.error(error);
                container.innerHTML = `
                    <div class="text-center py-10">
                        <div class="inline-flex p-3 rounded-full bg-red-500/10 text-red-400 mb-4"><i class="lucide-alert-circle w-8 h-8"></i></div>
                        <h3 class="text-xl font-bold text-white">Oops!</h3>
                        <p class="text-zinc-400">${error.message || "Failed to load module."}</p>
                        <button onclick="loadModule(${index})" class="mt-4 px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded text-sm transition">Try Again</button>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        // 6. NAVIGATION & INTERACTION
        function nextCard() {
            if (lessonData && currentIndex < lessonData.cards.length - 1) {
                currentIndex++;
                renderCard();
            } else {
                if (typeof confetti === 'function') confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                setTimeout(() => {
                    alert("ðŸŽ‰ Module Complete! Moving to dashboard...");
                    window.location.href = '/dashboard';
                }, 1500);
            }
        }

        function prevCard() {
            if (currentIndex > 0) {
                currentIndex--;
                renderCard();
            }
        }

        function checkAnswer(btn, selected, correct) {
            const feedback = document.getElementById('feedback-msg');
            const allBtns = btn.parentElement.querySelectorAll('button');
            allBtns.forEach(b => {
                b.disabled = true;
                b.classList.add('opacity-50', 'cursor-not-allowed');
            });
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            feedback.classList.remove('hidden', 'bg-green-500/10', 'text-green-400', 'bg-red-500/10', 'text-red-400');

            if (selected === correct) {
                btn.classList.add('bg-green-500/20', 'border-green-500/50', 'ring-1', 'ring-green-500/50');
                btn.querySelector('.check-dot').classList.add('bg-green-400', 'opacity-100');
                feedback.classList.add('bg-green-500/10', 'text-green-400', 'border', 'border-green-500/20');
                feedback.innerHTML = `<div class="flex items-center"><i class="lucide-check-circle-2 w-5 h-5 mr-2"></i> Correct!</div>`;
                if (typeof confetti === 'function') confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 } });
            } else {
                btn.classList.add('bg-red-500/20', 'border-red-500/50', 'ring-1', 'ring-red-500/50');
                feedback.classList.add('bg-red-500/10', 'text-red-400', 'border', 'border-red-500/20');
                feedback.innerHTML = `<div class="flex items-center"><i class="lucide-x-circle w-5 h-5 mr-2"></i> Incorrect. Answer: <strong>${correct}</strong>.</div>`;
            }
            lucide.createIcons();
        }

        // 7. VOICE INPUT
        function toggleVoice() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Voice input is not supported in this browser. Try Chrome.");
                return;
            }
            if (isListening) { recognition.stop(); return; }
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.onstart = () => {
                isListening = true;
                document.getElementById('mic-pulse').classList.remove('hidden');
                document.getElementById('tutor-input').placeholder = "Listening...";
            };
            recognition.onend = () => {
                isListening = false;
                document.getElementById('mic-pulse').classList.add('hidden');
                document.getElementById('tutor-input').placeholder = "Ask the AI Tutor...";
            };
            recognition.onresult = (event) => {
                document.getElementById('tutor-input').value = event.results[0][0].transcript;
            };
            recognition.start();
        }

        async function askTutor(e) {
            e.preventDefault();
            const input = document.getElementById('tutor-input');
            const question = input.value;
            if(!question) return;
            input.value = "Thinking...";
            input.disabled = true;
            setTimeout(() => {
                input.value = "";
                input.disabled = false;
                input.placeholder = "Ask another question...";
                const utterance = new SpeechSynthesisUtterance("That is a great question! Let me explain...");
                window.speechSynthesis.speak(utterance);
                alert("AI Tutor: That is a great question!");
            }, 1500);
        }

        // CONFETTI SCRIPT
        const script = document.createElement('script');
        script.src = "https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js";
        document.head.appendChild(script);

        // START
        renderCard();
    </script>
</body>
</html>
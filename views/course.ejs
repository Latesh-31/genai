<div class="flex h-[calc(100vh-65px)] overflow-hidden">
  <!-- Sidebar - Mind Map Syllabus -->
  <aside class="w-80 flex-shrink-0 overflow-y-auto border-r border-zinc-800 bg-zinc-950 p-6">
    <div class="mb-6">
      <a href="/dashboard" class="mb-4 inline-block text-xs text-zinc-500 hover:text-zinc-300">&larr; Dashboard</a>
      <h1 class="text-xl font-bold text-zinc-100"><%= course.topic %></h1>
      <div class="mt-2 flex items-center gap-2">
        <span class="rounded-full border border-zinc-800 bg-zinc-900 px-2 py-0.5 text-xs text-zinc-400">
          <%= course.level %>
        </span>
        <span class="text-xs text-zinc-500"><%= syllabus.length %> Modules</span>
      </div>
    </div>

    <!-- Mind Map Visualization -->
    <div class="mb-6 rounded-lg border border-zinc-800 bg-zinc-900/30 p-4">
      <h3 class="mb-4 text-sm font-semibold text-zinc-100">üó∫Ô∏è Learning Journey Map</h3>
      
      <div class="mind-map-grid grid grid-cols-3 gap-3">
        <% syllabus.forEach((module, mIdx) => { %>
          <% 
            // Determine module state
            const isCurrent = mIdx === 0; // Simplified for now
            const isCompleted = mIdx < (course.completed_modules || 0);
            const isLocked = mIdx > (course.completed_modules || 0);
          %>
          
          <div class="relative flex flex-col items-center">
            <!-- Module Node -->
            <div class="relative z-10 flex h-16 w-16 flex-col items-center justify-center rounded-full border-2 text-center transition-all 
              <% if (isCompleted) { %>border-green-500 bg-green-950/30 text-green-300<% } 
              else if (isCurrent) { %>border-indigo-500 bg-indigo-950/30 text-indigo-300 animate-pulse<% } 
              else if (isLocked) { %>border-zinc-700 bg-zinc-800 text-zinc-500 opacity-60<% } 
              else { %>border-zinc-700 bg-zinc-800 text-zinc-400<% } %>">
              <span class="text-xs font-bold"><%= mIdx + 1 %></span>
              <% if (isCompleted) { %>
                <span class="text-xs">‚úÖ</span>
              <% } else if (isLocked) { %>
                <span class="text-xs">üîí</span>
              <% } else { %>
                <span class="text-xs">üìö</span>
              <% } %>
            </div>
            
            <!-- Module Title -->
            <div class="mt-2 text-center">
              <span class="text-xs font-medium 
                <% if (isCompleted) { %>text-green-400<% } 
                else if (isCurrent) { %>text-indigo-400<% } 
                else if (isLocked) { %>text-zinc-600<% } 
                else { %>text-zinc-400<% } %>">
                <%= module.title.substring(0, 15) %><% if (module.title.length > 15) { %>...<% } %>
              </span>
            </div>
          </div>
        <% }) %>
      </div>
      
      <!-- Connections between nodes -->
      <div class="pointer-events-none absolute inset-0 flex items-center justify-center">
        <svg class="h-full w-full" fill="none" stroke="currentColor" stroke-width="1">
          <% for (let i = 0; i < syllabus.length - 1; i++) { %>
            <line x1="<%= 20 + (i % 3) * 100 %>" y1="<%= 60 + Math.floor(i / 3) * 80 %>"
                  x2="<%= 20 + ((i + 1) % 3) * 100 %>" y2="<%= 60 + Math.floor((i + 1) / 3) * 80 %>"
                  class="stroke-zinc-700 transition-all 
                    <% if (i < (course.completed_modules || 0)) { %>stroke-green-500<% } 
                    else if (i === (course.completed_modules || 0)) { %>stroke-indigo-500<% } 
                    else { %>stroke-zinc-700<% } %>" />
          <% } %>
        </svg>
      </div>
    </div>

    <!-- Traditional Module List -->
    <div class="space-y-6">
      <% syllabus.forEach((module, mIdx) => { %>
        <% 
          const isCurrentModule = mIdx === 0; // Simplified
          const isLocked = mIdx > (course.completed_modules || 0);
          const isCompleted = mIdx < (course.completed_modules || 0);
        %>
        
        <div class="relative pl-4">
          <!-- Timeline line -->
          <div class="absolute left-0 top-2 h-full w-0.5 
            <% if (isCompleted) { %>bg-green-500<% } 
            else if (isCurrentModule) { %>bg-indigo-500<% } 
            else { %>bg-zinc-800<% } %>"></div>
          
          <h3 class="relative mb-2 text-sm font-semibold text-zinc-200">
            <span class="absolute -left-[21px] top-0.5 h-3 w-3 rounded-full border-2 border-zinc-950 
              <% if (isCompleted) { %>bg-green-500<% } 
              else if (isCurrentModule) { %>bg-indigo-500 animate-pulse<% } 
              else if (isLocked) { %>bg-zinc-700<% } 
              else { %>bg-zinc-700<% } %>"></span>
            <%= module.title %>
            <% if (isLocked) { %>
              <span class="ml-2 rounded border border-zinc-700 bg-zinc-800 px-2 py-0.5 text-xs text-zinc-400">üîí Locked</span>
            <% } %>
          </h3>
          <p class="mb-3 text-xs text-zinc-500"><%= module.description %></p>
          
          <ul class="space-y-1">
            <% module.topics.forEach((topic, tIdx) => { %>
              <li>
                <button 
                  onclick="<%= isLocked ? 'showLockedModuleAlert()' : `loadLesson(${course.id}, ${mIdx}, ${tIdx})` %>"
                  class="w-full rounded px-2 py-1.5 text-left text-sm transition-colors 
                    <% if (isLocked) { %>
                      cursor-not-allowed text-zinc-600 hover:bg-zinc-900 hover:text-zinc-600
                    <% } else { %>
                      text-zinc-400 hover:bg-zinc-900 hover:text-zinc-200 focus:bg-zinc-900 focus:text-zinc-100 focus:outline-none
                    <% } %>"
                  id="btn-<%= mIdx %>-<%= tIdx %>"
                  <%= isLocked ? 'disabled' : '' %>>
                  <%= topic %>
                  <% if (isLocked) { %>
                    <span class="ml-1 text-xs">üîí</span>
                  <% } %>
                </button>
              </li>
            <% }) %>
          </ul>
          
          <% if (!isLocked && mIdx > 0 && mIdx === (course.completed_modules || 0)) { %>
            <div class="mt-3">
              <button 
                onclick="takeExitQuiz(<%= course.id %>, <%= mIdx - 1 %>)"
                class="w-full rounded border border-indigo-600 bg-indigo-600/10 px-3 py-1.5 text-xs text-indigo-300 transition-colors hover:bg-indigo-600/20">
                üéØ Take Exit Quiz to Unlock
              </button>
            </div>
          <% } %>
        </div>
      <% }) %>
    </div>
  </aside>

  <!-- Main Content Card Deck Interface -->
  <main class="flex-1 overflow-hidden bg-zinc-900/30">
    <div id="lesson-container" class="relative h-full w-full">
      <!-- Empty State -->
      <div id="empty-state" class="flex h-full flex-col items-center justify-center py-20 text-center">
        <div class="mb-4 rounded-full bg-zinc-900 p-4 ring-1 ring-zinc-800">
          <svg class="h-8 w-8 text-zinc-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
          </svg>
        </div>
        <h2 class="text-xl font-semibold text-zinc-200">Select a topic to start learning</h2>
        <p class="mt-2 text-zinc-500">Choose a lesson from the syllabus on the left.</p>
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="hidden flex h-full items-center justify-center">
        <div class="text-center">
          <div class="inline-block h-8 w-8 animate-spin rounded-full border-2 border-zinc-700 border-t-indigo-500"></div>
          <p class="mt-4 text-sm text-zinc-400">Generating lesson with AI üöÄ</p>
        </div>
      </div>

      <!-- Card Deck Interface -->
      <div id="card-deck" class="hidden h-full w-full p-8 sm:p-12">
        <!-- Progress Bar -->
        <div class="mb-8">
          <div class="mb-2 flex justify-between text-sm text-zinc-400">
            <span id="card-progress-label">Card 1 of X</span>
            <span>Progress</span>
          </div>
          <div class="h-2 w-full rounded-full bg-zinc-800">
            <div id="progress-bar" class="h-full rounded-full bg-gradient-to-r from-green-400 to-emerald-400 transition-all duration-300" style="width: 10%"></div>
          </div>
        </div>

        <!-- Current Card Display -->
        <div id="card-container" class="mx-auto max-w-3xl">
          <h1 id="lesson-title" class="mb-6 text-3xl font-bold text-zinc-100"></h1>
          
          <!-- Card Content -->
          <div id="card-content" class="relative rounded-xl border border-zinc-800 bg-zinc-900/50 p-8 shadow-2xl">
            <!-- Card Content Will Be Inserted Here -->
          </div>

          <!-- Navigation Buttons -->
          <div class="mt-6 flex justify-between">
            <button id="prev-btn" class="rounded-lg border border-zinc-700 bg-zinc-800 px-4 py-2 text-sm font-medium text-zinc-300 transition-colors hover:bg-zinc-700 hover:text-zinc-100 disabled:cursor-not-allowed disabled:opacity-50" disabled>
              ‚Üê Previous
            </button>
            <button id="next-btn" class="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 disabled:cursor-not-allowed disabled:opacity-50" disabled>
              Next ‚Üí
            </button>
          </div>
        </div>

        <!-- Completion Celebration -->
        <div id="completion-celebration" class="hidden absolute inset-0 flex items-center justify-center bg-zinc-900/90 backdrop-blur-sm">
          <div class="text-center">
            <div class="mb-4 text-6xl">üéâ</div>
            <h2 class="mb-2 text-3xl font-bold text-green-400">Lesson Complete! ü•≥</h2>
            <p class="mb-4 text-lg text-zinc-300">You've earned <span class="font-bold text-yellow-400">+100 XP</span>! üíé</p>
            <div class="flex justify-center gap-2">
              <button onclick="closeLesson()" class="rounded-lg bg-indigo-600 px-6 py-3 text-white transition-colors hover:bg-indigo-500">
                Back to Course
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Tutor Panel -->
      <section id="tutor-section" class="hidden absolute bottom-0 left-0 right-0 border-t border-zinc-800 bg-zinc-950/95 p-6 backdrop-blur-sm">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <h2 class="text-sm font-semibold text-zinc-200">AI Tutor</h2>

          <div class="flex items-center gap-2">
            <span id="listening-badge" class="hidden rounded-full border border-red-900 bg-red-950/30 px-2 py-0.5 text-xs text-red-300">
              Listening...
            </span>

            <span id="speaking-indicator" class="hidden items-center gap-2 rounded-full border border-indigo-900 bg-indigo-950/30 px-2 py-0.5 text-xs text-indigo-300">
              <span class="flex items-end gap-0.5" aria-hidden="true">
                <span class="h-1 w-0.5 animate-pulse rounded bg-indigo-400"></span>
                <span class="h-2 w-0.5 animate-pulse rounded bg-indigo-400"></span>
                <span class="h-3 w-0.5 animate-pulse rounded bg-indigo-400"></span>
                <span class="h-2 w-0.5 animate-pulse rounded bg-indigo-400"></span>
                <span class="h-1 w-0.5 animate-pulse rounded bg-indigo-400"></span>
              </span>
              Speaking...
            </span>

            <span id="voice-unsupported" class="hidden text-xs text-zinc-500">Voice not supported</span>
          </div>
        </div>

        <div id="tutor-messages" class="mt-4 space-y-3"></div>

        <form id="tutor-form" class="mt-4 flex items-center gap-2">
          <input
            id="tutor-input"
            name="question"
            type="text"
            autocomplete="off"
            placeholder="Ask the AI tutor about this lesson..."
            class="w-full rounded-lg border border-zinc-800 bg-zinc-950/60 px-3 py-2 text-sm text-zinc-100 placeholder:text-zinc-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/20"
          />

          <button
            id="mic-btn"
            type="button"
            class="inline-flex h-10 w-10 items-center justify-center rounded-lg border border-zinc-800 bg-zinc-950/40 text-zinc-400 transition-colors hover:bg-zinc-900 hover:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20"
            title="Speak"
            aria-label="Speak"
          >
            <svg id="mic-icon" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3Z" />
              <path d="M19 11a7 7 0 0 1-14 0" />
              <path d="M12 18v3" />
              <path d="M8 21h8" />
            </svg>
          </button>

          <button
            id="tts-stop-btn"
            type="button"
            class="inline-flex h-10 w-10 items-center justify-center rounded-lg border border-zinc-800 bg-zinc-950/40 text-zinc-400 transition-colors hover:bg-zinc-900 hover:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20"
            title="Stop speaking"
            aria-label="Stop speaking"
          >
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 5 6 9H3v6h3l5 4V5Z" />
              <path d="M23 9 17 15" />
              <path d="M17 9 23 15" />
            </svg>
          </button>

          <button
            type="submit"
            class="inline-flex h-10 items-center justify-center rounded-lg bg-indigo-600 px-4 text-sm font-medium text-white transition-colors hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30"
          >
            Send
          </button>
        </form>
      </section>
    </div>
  </main>
</div>

<!-- Exit Quiz Modal -->
<div id="exit-quiz-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-zinc-900/80 backdrop-blur-sm">
  <div class="w-full max-w-md rounded-xl border border-zinc-800 bg-zinc-950 p-6">
    <div class="mb-4 flex items-center justify-between">
      <h2 class="text-lg font-semibold text-zinc-100">üéØ Module Exit Quiz</h2>
      <button onclick="closeExitQuizModal()" class="text-zinc-400 hover:text-zinc-200">
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6 6 18" />
          <path d="M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <p class="mb-4 text-sm text-zinc-400">Answer these questions to unlock the next module. You need to score at least 66% to pass.</p>
    
    <div id="exit-quiz-questions" class="space-y-4"></div>
    
    <div class="mt-6 flex justify-end gap-2">
      <button onclick="closeExitQuizModal()" class="rounded-lg border border-zinc-700 bg-zinc-800 px-4 py-2 text-sm text-zinc-300 hover:bg-zinc-700">
        Cancel
      </button>
      <button onclick="submitExitQuiz()" class="rounded-lg bg-indigo-600 px-4 py-2 text-sm text-white hover:bg-indigo-500">
        Submit Quiz
      </button>
    </div>
  </div>
</div>

<!-- Quiz Result Modal -->
<div id="quiz-result-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-zinc-900/80 backdrop-blur-sm">
  <div class="w-full max-w-md rounded-xl border border-zinc-800 bg-zinc-950 p-6 text-center">
    <div id="quiz-result-content"></div>
    
    <div class="mt-6 flex justify-center gap-2">
      <button onclick="closeQuizResultModal()" class="rounded-lg bg-indigo-600 px-6 py-2 text-white hover:bg-indigo-500">
        Continue
      </button>
    </div>
  </div>
</div>

<!-- Confetti Canvas -->
<canvas id="confetti-canvas" class="pointer-events-none fixed inset-0 z-50 hidden"></canvas>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  const COURSE_ID = <%= Number(course.id) %>;
  const COMPLETED_MODULES = <%= course.completed_modules || 0 %>;
  
  let currentLesson = null;
  let currentCardIndex = 0;
  let lessonProgress = { completed: false };
  let currentExitQuiz = null;
  let currentModuleIndex = null;

  // Card rendering functions
  function renderTextCard(card) {
    return `
      <div class="text-lg text-zinc-100">
        ${marked.parse(card.content)}
      </div>
      ${card.image ? `<img src="${card.image}" alt="Lesson image" class="mt-4 rounded-lg">` : ''}
    `;
  }

  function renderQuizCard(card, cardIndex) {
    return `
      <div class="text-center">
        <h3 class="mb-6 text-2xl font-bold text-zinc-100">${card.question}</h3>
        <div class="grid gap-3" id="quiz-options-${cardIndex}">
          ${card.options.map((option, idx) => `
            <button 
              onclick="selectQuizOption('${card.answer}', '${option}', ${cardIndex}, ${idx})"
              class="quiz-option rounded-lg border border-zinc-700 bg-zinc-800 px-4 py-3 text-zinc-300 transition-all hover:border-zinc-600 hover:bg-zinc-700 hover:text-zinc-100 text-left disabled:cursor-not-allowed"
            >
              ${option}
            </button>
          `).join('')}
        </div>
        <div id="quiz-feedback-${cardIndex}" class="mt-4 hidden rounded-lg p-3 text-sm"></div>
      </div>
    `;
  }

  function renderChallengeCard(card) {
    return `
      <div class="text-center">
        <div class="mb-2 text-4xl">üéØ</div>
        <h3 class="mb-4 text-xl font-bold text-zinc-100">Challenge Time!</h3>
        <p class="mb-6 text-lg text-zinc-200">${card.prompt}</p>
        <div class="rounded-lg border border-dashed border-zinc-700 bg-zinc-800/50 p-6 text-center text-zinc-400">
          üí° Hint: ${card.hint}
        </div>
      </div>
    `;
  }

  function renderCard(card, index) {
    switch (card.type) {
      case 'text':
        return renderTextCard(card);
      case 'quiz':
        return renderQuizCard(card, index);
      case 'challenge':
        return renderChallengeCard(card);
      default:
        return '<div class="text-red-400">Unknown card type</div>';
    }
  }

  function updateProgress() {
    if (!currentLesson) return;
    
    const progressLabel = document.getElementById('card-progress-label');
    const progressBar = document.getElementById('progress-bar');
    
    progressLabel.textContent = `Card ${currentCardIndex + 1} of ${currentLesson.cards.length}`;
    
    const percentage = ((currentCardIndex + 1) / currentLesson.cards.length) * 100;
    progressBar.style.width = `${percentage}%`;
  }

  function refreshCard() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const cardContent = document.getElementById('card-content');
    const tutorSection = document.getElementById('tutor-section');
    
    if (!currentLesson || !currentLesson.cards[currentCardIndex]) return;
    
    const card = currentLesson.cards[currentCardIndex];
    cardContent.innerHTML = renderCard(card, currentCardIndex);
    
    // Update navigation buttons
    prevBtn.disabled = currentCardIndex === 0;
    
    // Enable next button for text cards, disable for quiz cards initially
    if (card.type === 'text' || card.type === 'challenge') {
      nextBtn.disabled = false;
      nextBtn.textContent = currentCardIndex === currentLesson.cards.length - 1 ? 'Finish!' : 'Next ‚Üí';
    } else {
      nextBtn.disabled = true;
      nextBtn.textContent = 'Answer first!';
    }
    
    updateProgress();
    
    // Show tutor section for all cards after the first one
    if (currentCardIndex > 0) {
      tutorSection.classList.remove('hidden');
    }
  }

  function nextCard() {
    if (currentCardIndex < currentLesson.cards.length - 1) {
      currentCardIndex++;
      refreshCard();
    } else {
      completeLesson();
    }
  }

  function previousCard() {
    if (currentCardIndex > 0) {
      currentCardIndex--;
      refreshCard();
    }
  }

  function selectQuizOption(correctAnswer, selectedAnswer, cardIndex, optionIndex) {
    const options = document.querySelectorAll(`#quiz-options-${cardIndex} .quiz-option`);
    const feedback = document.getElementById(`quiz-feedback-${cardIndex}`);
    const nextBtn = document.getElementById('next-btn');
    
    // Disable all options
    options.forEach(opt => opt.disabled = true);
    
    // Style the selected option
    if (selectedAnswer === correctAnswer) {
      options[optionIndex].classList.add('bg-green-600', 'border-green-500', 'text-white');
      options[optionIndex].classList.add('animate-bounce');
      feedback.className = 'mt-4 rounded-lg bg-green-950/30 p-3 text-sm text-green-300';
      feedback.textContent = 'üéâ Correct! ' + currentLesson.cards[cardIndex].explanation;
      nextBtn.disabled = false;
      nextBtn.textContent = 'Next ‚Üí';
    } else {
      options[optionIndex].classList.add('bg-red-600', 'border-red-500', 'text-white');
      // Find and highlight the correct answer
      options.forEach((opt, idx) => {
        if (opt.textContent.trim() === correctAnswer) {
          opt.classList.add('bg-green-600', 'border-green-500', 'text-white');
        }
      });
      feedback.className = 'mt-4 rounded-lg bg-red-950/30 p-3 text-sm text-red-300';
      feedback.textContent = 'üíî Not quite! ' + currentLesson.cards[cardIndex].explanation;
      nextBtn.disabled = false;
      nextBtn.textContent = 'Next ‚Üí';
    }
    
    feedback.classList.remove('hidden');
  }

  function completeLesson() {
    const completionCelebration = document.getElementById('completion-celebration');
    completionCelebration.classList.remove('hidden');
    
    // Trigger confetti
    triggerConfetti();
    
    // Mark lesson as completed
    lessonProgress.completed = true;
    
    // Award XP (this would be sent to the server)
    awardExperiencePoints(100);
  }

  function awardExperiencePoints(points) {
    // Send to server to update user's XP
    fetch(`/course/${COURSE_ID}/complete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        xpEarned: points
      })
    }).catch(err => console.error('Failed to award XP:', err));
  }

  function closeLesson() {
    const emptyState = document.getElementById('empty-state');
    
    document.getElementById('card-deck').classList.add('hidden');
    emptyState.classList.remove('hidden');
    
    currentLesson = null;
    currentCardIndex = 0;
  }

  async function loadLesson(courseId, moduleIdx, topicIdx) {
    const emptyState = document.getElementById('empty-state');
    const loadingState = document.getElementById('loading-state');
    const cardDeck = document.getElementById('card-deck');
    const tutorSection = document.getElementById('tutor-section');
    
    emptyState.classList.add('hidden');
    cardDeck.classList.add('hidden');
    loadingState.classList.remove('hidden');
    tutorSection.classList.add('hidden');
    
    // Clear tutor messages
    document.getElementById('tutor-messages').innerHTML = '';
    
    // Update active button
    document.querySelectorAll('button[id^="btn-"]').forEach(btn => {
      btn.classList.remove('bg-zinc-800', 'text-zinc-100', 'font-medium');
      btn.classList.add('text-zinc-400');
    });
    
    const activeBtn = document.getElementById(`btn-${moduleIdx}-${topicIdx}`);
    if (activeBtn) {
      activeBtn.classList.add('bg-zinc-800', 'text-zinc-100', 'font-medium');
      activeBtn.classList.remove('text-zinc-400');
    }
    
    try {
      const response = await fetch(`/course/${courseId}/lesson/${moduleIdx}/${topicIdx}`);
      if (!response.ok) throw new Error('Failed to load lesson');
      
      const data = await response.json();
      
      // Setup lesson data
      currentLesson = {
        title: data.title,
        cards: data.cards
      };
      currentCardIndex = 0;
      
      document.getElementById('lesson-title').textContent = data.title;
      
      loadingState.classList.add('hidden');
      cardDeck.classList.remove('hidden');
      
      // Initialize first card
      refreshCard();
      
    } catch (err) {
      console.error(err);
      loadingState.classList.add('hidden');
      emptyState.classList.remove('hidden');
      emptyState.querySelector('h2').textContent = 'Error loading lesson';
      emptyState.querySelector('p').textContent = 'Please try again.';
    }
  }

  // Exit Quiz Functions
  function showLockedModuleAlert() {
    alert('üîí This module is locked. Complete the previous module and pass the exit quiz to unlock it.');
  }

  async function takeExitQuiz(courseId, moduleIdx) {
    currentModuleIndex = moduleIdx;
    
    try {
      const response = await fetch(`/course/${courseId}/module/${moduleIdx}/exit-quiz`);
      if (!response.ok) throw new Error('Failed to load exit quiz');
      
      const data = await response.json();
      currentExitQuiz = data.quiz;
      
      // Display quiz in modal
      const questionsContainer = document.getElementById('exit-quiz-questions');
      questionsContainer.innerHTML = '';
      
      data.quiz.forEach((question, index) => {
        const questionElement = document.createElement('div');
        questionElement.className = 'rounded-lg border border-zinc-800 bg-zinc-900/30 p-4';
        questionElement.innerHTML = `
          <h3 class="mb-3 font-medium text-zinc-100">Question ${index + 1}</h3>
          <p class="mb-3 text-sm text-zinc-300">${question.question}</p>
          <div class="grid gap-2">
            ${question.options.map((option, optIndex) => `
              <label class="flex items-center gap-2">
                <input type="radio" name="q${index}" value="${optIndex}" class="text-indigo-500">
                <span class="text-sm text-zinc-200">${option}</span>
              </label>
            `).join('')}
          </div>
        `;
        questionsContainer.appendChild(questionElement);
      });
      
      // Show modal
      document.getElementById('exit-quiz-modal').classList.remove('hidden');
      
    } catch (err) {
      console.error(err);
      alert('Failed to load exit quiz. Please try again.');
    }
  }

  function closeExitQuizModal() {
    document.getElementById('exit-quiz-modal').classList.add('hidden');
  }

  async function submitExitQuiz() {
    if (!currentExitQuiz || currentModuleIndex === null) return;
    
    // Collect answers
    const answers = [];
    currentExitQuiz.forEach((_, index) => {
      const selected = document.querySelector(`input[name="q${index}"]:checked`);
      answers.push(selected ? parseInt(selected.value) : -1);
    });
    
    try {
      const response = await fetch(`/course/${COURSE_ID}/module/${currentModuleIndex}/verify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ answers })
      });
      
      if (!response.ok) throw new Error('Failed to submit quiz');
      
      const result = await response.json();
      
      closeExitQuizModal();
      
      // Show result modal
      const resultContent = document.getElementById('quiz-result-content');
      
      if (result.passed) {
        resultContent.innerHTML = `
          <div class="mb-4 text-4xl">üéâ</div>
          <h2 class="mb-2 text-2xl font-bold text-green-400">Congratulations! ü•≥</h2>
          <p class="mb-4 text-zinc-300">You passed the exit quiz with a score of <strong>${result.score}/3</strong>!</p>
          <p class="mb-4 text-sm text-zinc-400">${result.feedback}</p>
          <div class="inline-block rounded-lg border border-green-900 bg-green-950/30 px-3 py-1 text-sm text-green-300">
            üîì Module Unlocked!
          </div>
        `;
        
        // Update UI to show module as unlocked
        setTimeout(() => {
          location.reload(); // Refresh to update module states
        }, 2000);
        
      } else {
        resultContent.innerHTML = `
          <div class="mb-4 text-4xl">üíî</div>
          <h2 class="mb-2 text-2xl font-bold text-red-400">Not Quite There Yet</h2>
          <p class="mb-4 text-zinc-300">You scored <strong>${result.score}/3</strong>. You need at least 2 correct answers to pass.</p>
          <p class="mb-4 text-sm text-zinc-400">${result.feedback}</p>
          <p class="text-sm text-zinc-400">Please review the module content and try again!</p>
        `;
      }
      
      document.getElementById('quiz-result-modal').classList.remove('hidden');
      
    } catch (err) {
      console.error(err);
      alert('Failed to submit quiz. Please try again.');
    }
  }

  function closeQuizResultModal() {
    document.getElementById('quiz-result-modal').classList.add('hidden');
  }

  // Event listeners
  document.getElementById('next-btn').addEventListener('click', nextCard);
  document.getElementById('prev-btn').addEventListener('click', previousCard);

  // Confetti animation
  function triggerConfetti() {
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.classList.remove('hidden');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    const confetti = [];
    const colors = ['#10b981', '#8b5cf6', '#f59e0b', '#3b82f6', '#ef4444', '#06b6d4'];
    
    for (let i = 0; i < 150; i++) {
      confetti.push({
        x: Math.random() * canvas.width,
        y: -Math.random() * 100,
        vx: Math.random() * 4 - 2,
        vy: Math.random() * 3 + 2,
        color: colors[Math.floor(Math.random() * colors.length)],
        size: Math.random() * 6 + 2,
        rotation: Math.random() * 360,
        rotationSpeed: Math.random() * 10 - 5
      });
    }
    
    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      confetti.forEach((c, i) => {
        c.x += c.vx;
        c.y += c.vy;
        c.vy += 0.1;
        c.rotation += c.rotationSpeed;
        
        ctx.save();
        ctx.translate(c.x, c.y);
        ctx.rotate(c.rotation * Math.PI / 180);
        ctx.fillStyle = c.color;
        ctx.fillRect(-c.size/2, -c.size/2, c.size, c.size);
        ctx.restore();
        
        if (c.y > canvas.height + 50) {
          c.y = -50;
          c.x = Math.random() * canvas.width;
        }
      });
      
      requestAnimationFrame(animate);
    }
    
    animate();
    
    // Hide confetti after 3 seconds
    setTimeout(() => {
      canvas.classList.add('hidden');
    }, 3000);
  }

  // Voice interaction setup
  const voiceUI = {
    listening: false,
    recognition: null,
    inputEl: null,
    micBtn: null,
    micIcon: null,
    listeningBadge: null,
    speakingIndicator: null,
    stopBtn: null,
    unsupportedText: null
  };

  const tutorState = {
    lessonTopic: '',
    lessonText: ''
  };

  function setupVoiceInteraction() {
    voiceUI.inputEl = document.getElementById('tutor-input');
    voiceUI.micBtn = document.getElementById('mic-btn');
    voiceUI.listeningBadge = document.getElementById('listening-badge');
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const supportsSTT = typeof SpeechRecognition === 'function';
    
    if (!supportsSTT && voiceUI.micBtn) {
      voiceUI.micBtn.classList.add('hidden');
    }
    
    if (!supportsSTT) return;
    
    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.continuous = false;
    recognition.interimResults = false;
    
    recognition.addEventListener('result', (event) => {
      if (!voiceUI.inputEl) return;
      
      const transcript = event.results[0][0].transcript;
      voiceUI.inputEl.value = transcript;
      
      setTimeout(() => {
        const form = document.getElementById('tutor-form');
        if (form && voiceUI.inputEl.value.trim()) {
          form.requestSubmit();
        }
      }, 500);
    });
    
    recognition.addEventListener('start', () => {
      voiceUI.listening = true;
      if (voiceUI.micBtn) voiceUI.micBtn.classList.add('text-red-300');
      if (voiceUI.listeningBadge) voiceUI.listeningBadge.classList.remove('hidden');
    });
    
    recognition.addEventListener('end', () => {
      voiceUI.listening = false;
      if (voiceUI.micBtn) voiceUI.micBtn.classList.remove('text-red-300');
      if (voiceUI.listeningBadge) voiceUI.listeningBadge.classList.add('hidden');
    });
    
    voiceUI.recognition = recognition;
    
    if (voiceUI.micBtn) {
      voiceUI.micBtn.addEventListener('click', () => {
        if (voiceUI.listening) {
          recognition.stop();
        } else {
          recognition.start();
        }
      });
    }
  }

  function createTutorBubble(text, role) {
    const wrapper = document.createElement('div');
    wrapper.className = role === 'user' ? 'flex justify-end' : 'flex justify-start';

    const bubble = document.createElement('div');
    bubble.className =
      'max-w-[85%] rounded-lg border px-3 py-2 text-sm leading-relaxed ' +
      (role === 'user'
        ? 'border-zinc-700 bg-zinc-950/70 text-zinc-100'
        : 'border-zinc-800 bg-zinc-900/40 text-zinc-100');

    if (role === 'ai') {
      bubble.innerHTML = marked.parse(text || '');
    } else {
      bubble.textContent = text;
    }

    wrapper.appendChild(bubble);
    return wrapper;
  }

  function setupTutorChat() {
    const form = document.getElementById('tutor-form');
    const input = document.getElementById('tutor-input');
    const messages = document.getElementById('tutor-messages');

    if (!form || !input || !messages) return;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const question = (input.value || '').trim();
      if (!question) return;

      messages.appendChild(createTutorBubble(question, 'user'));
      input.value = '';

      const pending = createTutorBubble('Thinking... ü§î', 'ai');
      pending.scrollIntoView({ behavior: 'smooth', block: 'end' });
      messages.appendChild(pending);

      try {
        const response = await fetch(`/course/${COURSE_ID}/tutor`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            question,
            lessonTopic: currentLesson ? currentLesson.title : '',
            lessonText: currentLesson ? document.getElementById('card-content').innerText : ''
          })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data?.error || 'Failed to get tutor response');

        pending.replaceWith(createTutorBubble(data.answer || '', 'ai'));
      } catch (err) {
        pending.replaceWith(createTutorBubble('Sorry ‚Äî I could not answer that. Please try again. üòî', 'ai'));
        console.error(err);
      }
    });
  }

  // Initialize
  setupVoiceInteraction();
  setupTutorChat();
</script>
<div class="flex h-[calc(100vh-65px)] overflow-hidden">
  <aside class="w-[380px] flex-shrink-0 overflow-y-auto border-r border-zinc-800 bg-zinc-950 p-6">
    <div class="mb-6">
      <a href="/dashboard" class="mb-4 inline-block text-xs text-zinc-500 hover:text-zinc-300">&larr; Dashboard</a>
      <h1 class="text-xl font-bold text-zinc-100"><%= course.topic %></h1>
      <div class="mt-2 flex flex-wrap items-center gap-2">
        <span class="rounded-full border border-zinc-800 bg-zinc-900 px-2 py-0.5 text-xs text-zinc-400">
          <%= course.level %>
        </span>
        <span class="text-xs text-zinc-500"><%= syllabus.length %> Modules</span>
        <span class="text-xs text-zinc-500">‚Ä¢</span>
        <span class="text-xs text-zinc-500">Progress: <%= course.progress || 0 %>%</span>
      </div>
    </div>

    <style>
      @keyframes popIn { from { opacity: 0; transform: translate(-50%, -50%) scale(0.85); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
      .mind-node { animation: popIn .22s ease-out forwards; }
    </style>

    <section class="rounded-xl border border-zinc-800 bg-zinc-900/30 p-4">
      <div class="mb-3 flex items-center justify-between">
        <h2 class="text-sm font-semibold text-zinc-200">Learning Map</h2>
        <span class="text-xs text-zinc-500">Nodes & Edges</span>
      </div>

      <div id="mindmap" class="relative h-56 overflow-hidden rounded-lg bg-zinc-950/40 ring-1 ring-zinc-800">
        <svg class="absolute inset-0 h-full w-full" viewBox="0 0 100 100" preserveAspectRatio="none">
          <% for (let i = 0; i < syllabus.length - 1; i++) { %>
            <% const a = syllabus[i]?.node || { x: i % 2 === 0 ? 24 : 76, y: 12 + (i * 76 / Math.max(1, syllabus.length - 1)) }; %>
            <% const b = syllabus[i + 1]?.node || { x: (i + 1) % 2 === 0 ? 24 : 76, y: 12 + ((i + 1) * 76 / Math.max(1, syllabus.length - 1)) }; %>
            <line x1="<%= a.x %>" y1="<%= a.y %>" x2="<%= b.x %>" y2="<%= b.y %>" stroke="rgba(113,113,122,0.55)" stroke-width="1" />
          <% } %>
        </svg>

        <% syllabus.forEach((mod, mIdx) => { %>
          <% const node = mod?.node || { x: mIdx % 2 === 0 ? 24 : 76, y: 12 + (mIdx * 76 / Math.max(1, syllabus.length - 1)) }; %>
          <button
            id="module-node-<%= mIdx %>"
            type="button"
            data-module-index="<%= mIdx %>"
            style="left: <%= node.x %>%; top: <%= node.y %>%; animation-delay: <%= mIdx * 80 %>ms"
            class="mind-node absolute -translate-x-1/2 -translate-y-1/2 rounded-full border px-3 py-2 text-xs font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/30"
          >
            <span class="mr-1"><%= mIdx + 1 %></span>
            <span class="hidden sm:inline">‚Ä¢</span>
            <span class="hidden sm:inline"><%= (mod.title || '').split(':')[0].slice(0, 18) %></span>
          </button>
        <% }) %>
      </div>

      <div id="module-panel" class="mt-4 rounded-lg border border-zinc-800 bg-zinc-950/30 p-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div id="module-title" class="text-sm font-semibold text-zinc-100">Module</div>
            <div id="module-desc" class="mt-1 text-xs text-zinc-500"></div>
          </div>
          <span id="module-state-badge" class="rounded-full border border-zinc-800 bg-zinc-950 px-2 py-0.5 text-xs text-zinc-400"></span>
        </div>

        <div id="topics" class="mt-4 space-y-2"></div>
      </div>
    </section>
  </aside>

  <main class="flex-1 overflow-hidden bg-zinc-900/30">
    <div id="lesson-container" class="relative h-full w-full">
      <div id="empty-state" class="flex h-full flex-col items-center justify-center py-20 text-center">
        <div class="mb-4 rounded-full bg-zinc-900 p-4 ring-1 ring-zinc-800">
          <svg class="h-8 w-8 text-zinc-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
          </svg>
        </div>
        <h2 class="text-xl font-semibold text-zinc-200">Select a topic to start learning</h2>
        <p class="mt-2 text-zinc-500">Pick a module node on the left and choose a lesson.</p>
      </div>

      <div id="loading-state" class="hidden flex h-full items-center justify-center">
        <div class="text-center">
          <div class="inline-block h-8 w-8 animate-spin rounded-full border-2 border-zinc-700 border-t-indigo-500"></div>
          <p class="mt-4 text-sm text-zinc-400">Generating lesson with AI üöÄ</p>
        </div>
      </div>

      <div id="card-deck" class="hidden h-full w-full p-8 sm:p-12">
        <div class="mb-8">
          <div class="mb-2 flex justify-between text-sm text-zinc-400">
            <span id="card-progress-label">Card 1 of X</span>
            <span>Progress</span>
          </div>
          <div class="h-2 w-full rounded-full bg-zinc-800">
            <div id="progress-bar" class="h-full rounded-full bg-gradient-to-r from-green-400 to-emerald-400 transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>

        <div id="card-container" class="mx-auto max-w-3xl">
          <div class="mb-2 text-xs text-zinc-500" id="lesson-meta"></div>
          <h1 id="lesson-title" class="mb-6 text-3xl font-bold text-zinc-100"></h1>

          <div id="card-content" class="relative rounded-xl border border-zinc-800 bg-zinc-900/50 p-8 shadow-2xl"></div>

          <div class="mt-6 flex justify-between">
            <button id="prev-btn" class="rounded-lg border border-zinc-700 bg-zinc-800 px-4 py-2 text-sm font-medium text-zinc-300 transition-all hover:bg-zinc-700 hover:text-zinc-100 disabled:cursor-not-allowed disabled:opacity-50 active:scale-95" disabled>
              ‚Üê Previous
            </button>
            <button id="next-btn" class="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white transition-all hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 disabled:cursor-not-allowed disabled:opacity-50 active:scale-95" disabled>
              Next ‚Üí
            </button>
          </div>
        </div>

        <div id="completion-celebration" class="hidden absolute inset-0 flex items-center justify-center bg-zinc-900/90 backdrop-blur-sm">
          <div class="text-center">
            <div class="mb-4 text-6xl">üéâ</div>
            <h2 class="mb-2 text-3xl font-bold text-green-400">Lesson Complete!</h2>
            <p class="mb-4 text-lg text-zinc-300">You earned <span class="font-bold text-yellow-400">+100 XP</span></p>

            <div class="flex flex-wrap justify-center gap-2">
              <button onclick="closeLesson()" class="rounded-lg bg-zinc-800 px-6 py-3 text-white transition-all hover:bg-zinc-700 active:scale-95">
                Back to Map
              </button>
              <button id="unlock-next-btn" onclick="openExitQuiz()" class="hidden rounded-lg bg-indigo-600 px-6 py-3 text-white transition-all hover:bg-indigo-500 active:scale-95">
                Take Quiz to Unlock Next Module
              </button>
            </div>
          </div>
        </div>
      </div>

      <section id="tutor-section" class="hidden absolute bottom-0 left-0 right-0 border-t border-zinc-800 bg-zinc-950/95 p-6 backdrop-blur-sm">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <h2 class="text-sm font-semibold text-zinc-200">AI Tutor</h2>

          <div class="flex items-center gap-2">
            <span id="listening-badge" class="hidden rounded-full border border-red-900 bg-red-950/30 px-2 py-0.5 text-xs text-red-300">Listening...</span>
            <span id="voice-unsupported" class="hidden text-xs text-zinc-500">Voice not supported</span>
          </div>
        </div>

        <div id="tutor-messages" class="mt-4 space-y-3"></div>

        <form id="tutor-form" class="mt-4 flex items-center gap-2">
          <input
            id="tutor-input"
            name="question"
            type="text"
            autocomplete="off"
            placeholder="Ask the AI tutor about this lesson..."
            class="w-full rounded-lg border border-zinc-800 bg-zinc-950/60 px-3 py-2 text-sm text-zinc-100 placeholder:text-zinc-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/20"
          />

          <button
            id="mic-btn"
            type="button"
            class="inline-flex h-10 w-10 items-center justify-center rounded-lg border border-zinc-800 bg-zinc-950/40 text-zinc-400 transition-all hover:bg-zinc-900 hover:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 active:scale-95"
            title="Speak"
            aria-label="Speak"
          >
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3Z" />
              <path d="M19 11a7 7 0 0 1-14 0" />
              <path d="M12 18v3" />
              <path d="M8 21h8" />
            </svg>
          </button>

          <button
            type="submit"
            class="inline-flex h-10 items-center justify-center rounded-lg bg-indigo-600 px-4 text-sm font-medium text-white transition-all hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 active:scale-95"
          >
            Send
          </button>
        </form>
      </section>

      <div id="exit-quiz-modal" class="hidden absolute inset-0 z-40 items-center justify-center bg-zinc-950/70 p-6 backdrop-blur-sm">
        <div class="w-full max-w-2xl rounded-2xl border border-zinc-800 bg-zinc-900/70 p-6">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-xs font-semibold tracking-widest text-zinc-400">GATEKEEPER QUIZ</div>
              <h3 id="exit-quiz-title" class="mt-2 text-xl font-bold text-zinc-100">Exit Quiz</h3>
              <p class="mt-1 text-sm text-zinc-400">Score 2/3 to unlock the next module.</p>
            </div>
            <button type="button" onclick="closeExitQuiz()" class="rounded-lg border border-zinc-800 bg-zinc-950/40 px-3 py-2 text-sm text-zinc-200 transition-all hover:bg-zinc-900 active:scale-95">Close</button>
          </div>

          <div id="exit-quiz-body" class="mt-5 space-y-5"></div>

          <div id="exit-quiz-feedback" class="mt-5 hidden rounded-xl border border-zinc-800 bg-zinc-950/40 p-4 text-sm"></div>

          <div class="mt-6 flex justify-end gap-3">
            <button type="button" onclick="submitExitQuiz()" class="rounded-xl bg-indigo-600 px-5 py-3 text-sm font-semibold text-white transition-all hover:bg-indigo-500 active:scale-95">Submit & Unlock</button>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<canvas id="confetti-canvas" class="pointer-events-none fixed inset-0 z-50 hidden"></canvas>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  const COURSE_ID = <%= Number(course.id) %>;
  const SYLLABUS = <%- JSON.stringify(syllabus || []) %>;
  let completedModules = <%= Number.isInteger(course.completed_modules) ? course.completed_modules : 0 %>;

  let selectedModuleIndex = Math.min(completedModules, Math.max(0, SYLLABUS.length - 1));
  let activeModuleIdx = null;
  let activeTopicIdx = null;

  let currentLesson = null;
  let currentCardIndex = 0;

  function moduleState(idx) {
    if (idx < completedModules) return 'completed';
    if (idx === completedModules) return 'current';
    return 'locked';
  }

  function stateBadgeText(state) {
    if (state === 'completed') return '‚úÖ Completed';
    if (state === 'current') return 'üü¢ Unlocked';
    return 'üîí Locked';
  }

  function buildFallbackExitQuiz(mod) {
    const topics = Array.isArray(mod?.topics) ? mod.topics : [];
    const seed = topics.slice(0, 3);
    const promptTopic = seed[0] || mod?.title || 'this module';

    return Array.from({ length: 3 }).map((_, idx) => {
      const focus = seed[idx] || promptTopic;

      return {
        question: `Quick check: which option best matches the key idea of "${focus}"?`,
        options: [
          `The core definition/concept of ${focus}`,
          `An unrelated idea that sounds similar`,
          `A common misconception about ${focus}`,
          `A detail that is true but not the main idea`
        ],
        correctIndex: 0
      };
    });
  }

  function getExitQuiz(mod) {
    const quiz = Array.isArray(mod?.exit_quiz) ? mod.exit_quiz : [];
    return quiz.length === 3 ? quiz : buildFallbackExitQuiz(mod);
  }

  function applyNodeState(nodeEl, idx) {
    const state = moduleState(idx);

    nodeEl.disabled = state === 'locked';

    nodeEl.className =
      'mind-node absolute -translate-x-1/2 -translate-y-1/2 rounded-full border px-3 py-2 text-xs font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 ' +
      (state === 'completed'
        ? 'border-green-800 bg-green-950/40 text-green-200 hover:bg-green-950/70'
        : state === 'current'
          ? 'border-indigo-700 bg-indigo-950/40 text-indigo-200 shadow-lg shadow-indigo-500/20 animate-pulse'
          : 'border-zinc-800 bg-zinc-950/60 text-zinc-500 cursor-not-allowed');
  }

  function renderMindMap() {
    for (let i = 0; i < SYLLABUS.length; i++) {
      const nodeEl = document.getElementById(`module-node-${i}`);
      if (!nodeEl) continue;
      applyNodeState(nodeEl, i);
    }
  }

  function renderModulePanel(moduleIndex) {
    const mod = SYLLABUS[moduleIndex];
    if (!mod) return;

    const state = moduleState(moduleIndex);
    const titleEl = document.getElementById('module-title');
    const descEl = document.getElementById('module-desc');
    const badgeEl = document.getElementById('module-state-badge');
    const topicsEl = document.getElementById('topics');

    titleEl.textContent = `Module ${moduleIndex + 1}: ${mod.title || ''}`;
    descEl.textContent = mod.description || '';
    badgeEl.textContent = stateBadgeText(state);

    if (state === 'locked') {
      topicsEl.innerHTML = `
        <div class="rounded-lg border border-zinc-800 bg-zinc-950/40 p-4 text-sm text-zinc-400">
          This module is locked. Pass the exit quiz from Module ${completedModules + 1} to unlock it.
        </div>
      `;
      return;
    }

    const topics = Array.isArray(mod.topics) ? mod.topics : [];

    topicsEl.innerHTML = `
      <div class="text-xs font-semibold tracking-widest text-zinc-400">TOPICS</div>
      <div class="mt-2 space-y-2">
        ${topics.map((topic, tIdx) => `
          <button
            type="button"
            onclick="loadLesson(${COURSE_ID}, ${moduleIndex}, ${tIdx})"
            class="w-full rounded-lg border border-zinc-800 bg-zinc-950/40 px-3 py-2 text-left text-sm text-zinc-200 transition-all hover:bg-zinc-900 active:scale-[0.99]"
          >
            ${topic}
          </button>
        `).join('')}
      </div>
    `;
  }

  document.querySelectorAll('[id^="module-node-"]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const idx = Number(btn.dataset.moduleIndex);
      if (!Number.isInteger(idx)) return;
      selectedModuleIndex = idx;
      renderModulePanel(selectedModuleIndex);
    });
  });

  function renderTextCard(card) {
    return `
      <div class="text-lg text-zinc-100">${marked.parse(card.content || '')}</div>
      ${card.image ? `<img src="${card.image}" alt="Lesson image" class="mt-4 rounded-lg">` : ''}
    `;
  }

  function renderQuizCard(card, cardIndex) {
    return `
      <div class="text-center">
        <h3 class="mb-6 text-2xl font-bold text-zinc-100">${card.question}</h3>
        <div class="grid gap-3" id="quiz-options-${cardIndex}">
          ${(card.options || []).map((option, idx) => `
            <button
              type="button"
              onclick="selectQuizOption('${(card.answer || '').replace(/'/g, "\\'")}', '${String(option).replace(/'/g, "\\'")}', ${cardIndex}, ${idx})"
              class="quiz-option rounded-lg border border-zinc-700 bg-zinc-800 px-4 py-3 text-left text-zinc-300 transition-all hover:border-zinc-600 hover:bg-zinc-700 hover:text-zinc-100 disabled:cursor-not-allowed"
            >
              ${option}
            </button>
          `).join('')}
        </div>
        <div id="quiz-feedback-${cardIndex}" class="mt-4 hidden rounded-lg p-3 text-sm"></div>
      </div>
    `;
  }

  function renderChallengeCard(card) {
    return `
      <div class="text-center">
        <div class="mb-2 text-4xl">üéØ</div>
        <h3 class="mb-4 text-xl font-bold text-zinc-100">Challenge Time!</h3>
        <p class="mb-6 text-lg text-zinc-200">${card.prompt}</p>
        <div class="rounded-lg border border-dashed border-zinc-700 bg-zinc-800/50 p-6 text-center text-zinc-400">
          üí° Hint: ${card.hint}
        </div>
      </div>
    `;
  }

  function renderCard(card, index) {
    if (!card) return '<div class="text-red-400">Missing card</div>';
    if (card.type === 'text') return renderTextCard(card);
    if (card.type === 'quiz') return renderQuizCard(card, index);
    if (card.type === 'challenge') return renderChallengeCard(card);
    return '<div class="text-red-400">Unknown card type</div>';
  }

  function updateProgress() {
    if (!currentLesson) return;

    const progressLabel = document.getElementById('card-progress-label');
    const progressBar = document.getElementById('progress-bar');

    progressLabel.textContent = `Card ${currentCardIndex + 1} of ${currentLesson.cards.length}`;

    const percentage = ((currentCardIndex + 1) / currentLesson.cards.length) * 100;
    progressBar.style.width = `${percentage}%`;
  }

  function refreshCard() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const cardContent = document.getElementById('card-content');
    const tutorSection = document.getElementById('tutor-section');

    if (!currentLesson || !currentLesson.cards[currentCardIndex]) return;

    const card = currentLesson.cards[currentCardIndex];
    cardContent.innerHTML = renderCard(card, currentCardIndex);

    prevBtn.disabled = currentCardIndex === 0;

    if (card.type === 'quiz') {
      nextBtn.disabled = true;
      nextBtn.textContent = 'Answer first';
    } else {
      nextBtn.disabled = false;
      nextBtn.textContent = currentCardIndex === currentLesson.cards.length - 1 ? 'Finish!' : 'Next ‚Üí';
    }

    updateProgress();
    tutorSection.classList.toggle('hidden', currentCardIndex === 0);
  }

  function nextCard() {
    if (!currentLesson) return;
    if (currentCardIndex < currentLesson.cards.length - 1) {
      currentCardIndex++;
      refreshCard();
    } else {
      completeLesson();
    }
  }

  function previousCard() {
    if (currentCardIndex > 0) {
      currentCardIndex--;
      refreshCard();
    }
  }

  function selectQuizOption(correctAnswer, selectedAnswer, cardIndex, optionIndex) {
    const options = document.querySelectorAll(`#quiz-options-${cardIndex} .quiz-option`);
    const feedback = document.getElementById(`quiz-feedback-${cardIndex}`);
    const nextBtn = document.getElementById('next-btn');

    options.forEach((opt) => (opt.disabled = true));

    if (selectedAnswer === correctAnswer) {
      options[optionIndex].classList.add('bg-green-600', 'border-green-500', 'text-white');
      feedback.className = 'mt-4 rounded-lg bg-green-950/30 p-3 text-sm text-green-300';
      feedback.textContent = 'üéâ Correct! ' + (currentLesson.cards[cardIndex].explanation || '');
    } else {
      options[optionIndex].classList.add('bg-red-600', 'border-red-500', 'text-white');
      options.forEach((opt) => {
        if (opt.textContent.trim() === correctAnswer) {
          opt.classList.add('bg-green-600', 'border-green-500', 'text-white');
        }
      });
      feedback.className = 'mt-4 rounded-lg bg-red-950/30 p-3 text-sm text-red-300';
      feedback.textContent = 'üíî Not quite. ' + (currentLesson.cards[cardIndex].explanation || '');
    }

    feedback.classList.remove('hidden');
    nextBtn.disabled = false;
    nextBtn.textContent = currentCardIndex === currentLesson.cards.length - 1 ? 'Finish!' : 'Next ‚Üí';
  }

  async function awardExperiencePoints(points) {
    if (activeModuleIdx == null || activeTopicIdx == null) return;

    try {
      await fetch(`/course/${COURSE_ID}/complete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          moduleIndex: activeModuleIdx,
          topicIndex: activeTopicIdx,
          xpEarned: points
        })
      });
    } catch (err) {
      console.error('Failed to award XP:', err);
    }
  }

  function completeLesson() {
    document.getElementById('completion-celebration').classList.remove('hidden');
    triggerConfetti();
    awardExperiencePoints(100);

    const unlockBtn = document.getElementById('unlock-next-btn');
    const isCurrentModule = activeModuleIdx === completedModules;
    const mod = SYLLABUS[activeModuleIdx];
    const lastTopicIdx = mod && Array.isArray(mod.topics) ? mod.topics.length - 1 : -1;

    const shouldOfferExitQuiz =
      isCurrentModule &&
      activeTopicIdx === lastTopicIdx &&
      completedModules < SYLLABUS.length - 1;

    unlockBtn.classList.toggle('hidden', !shouldOfferExitQuiz);
  }

  function closeLesson() {
    document.getElementById('card-deck').classList.add('hidden');
    document.getElementById('completion-celebration').classList.add('hidden');
    document.getElementById('empty-state').classList.remove('hidden');

    currentLesson = null;
    currentCardIndex = 0;
  }

  async function loadLesson(courseId, moduleIdx, topicIdx) {
    activeModuleIdx = moduleIdx;
    activeTopicIdx = topicIdx;

    document.getElementById('empty-state').classList.add('hidden');
    document.getElementById('card-deck').classList.add('hidden');
    document.getElementById('completion-celebration').classList.add('hidden');
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('tutor-section').classList.add('hidden');

    document.getElementById('tutor-messages').innerHTML = '';

    try {
      const response = await fetch(`/course/${courseId}/lesson/${moduleIdx}/${topicIdx}`);
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data?.error || 'Failed to load lesson');
      }

      currentLesson = {
        title: data.title,
        cards: Array.isArray(data.cards) ? data.cards : []
      };
      currentCardIndex = 0;

      document.getElementById('lesson-title').textContent = data.title;
      document.getElementById('lesson-meta').textContent = `Module ${moduleIdx + 1} ‚Ä¢ Topic ${topicIdx + 1}`;

      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('card-deck').classList.remove('hidden');

      refreshCard();
    } catch (err) {
      console.error(err);
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('empty-state').classList.remove('hidden');
      document.querySelector('#empty-state h2').textContent = 'Error loading lesson';
      document.querySelector('#empty-state p').textContent = err.message || 'Please try again.';
    }
  }

  document.getElementById('next-btn').addEventListener('click', nextCard);
  document.getElementById('prev-btn').addEventListener('click', previousCard);

  function triggerConfetti() {
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');

    canvas.classList.remove('hidden');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const confetti = [];
    const colors = ['#10b981', '#8b5cf6', '#f59e0b', '#3b82f6', '#ef4444', '#06b6d4'];

    for (let i = 0; i < 160; i++) {
      confetti.push({
        x: Math.random() * canvas.width,
        y: -Math.random() * 100,
        vx: Math.random() * 4 - 2,
        vy: Math.random() * 3 + 2,
        color: colors[Math.floor(Math.random() * colors.length)],
        size: Math.random() * 6 + 2,
        rotation: Math.random() * 360,
        rotationSpeed: Math.random() * 10 - 5
      });
    }

    const start = performance.now();

    function animate(now) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      confetti.forEach((c) => {
        c.x += c.vx;
        c.y += c.vy;
        c.vy += 0.07;
        c.rotation += c.rotationSpeed;

        ctx.save();
        ctx.translate(c.x, c.y);
        ctx.rotate((c.rotation * Math.PI) / 180);
        ctx.fillStyle = c.color;
        ctx.fillRect(-c.size / 2, -c.size / 2, c.size, c.size);
        ctx.restore();
      });

      if (now - start < 2200) {
        requestAnimationFrame(animate);
      } else {
        canvas.classList.add('hidden');
      }
    }

    requestAnimationFrame(animate);
  }

  function openExitQuiz() {
    const modal = document.getElementById('exit-quiz-modal');
    const body = document.getElementById('exit-quiz-body');
    const feedback = document.getElementById('exit-quiz-feedback');

    const mod = SYLLABUS[activeModuleIdx];
    const quiz = getExitQuiz(mod);

    document.getElementById('exit-quiz-title').textContent = `Module ${activeModuleIdx + 1} Exit Quiz`;

    feedback.classList.add('hidden');
    feedback.textContent = '';

    body.innerHTML = quiz.map((q, qIdx) => `
      <div class="rounded-xl border border-zinc-800 bg-zinc-950/40 p-4">
        <div class="text-sm font-semibold text-zinc-100">${qIdx + 1}. ${q.question}</div>
        <div class="mt-3 space-y-2">
          ${(q.options || []).map((opt, oIdx) => `
            <label class="flex cursor-pointer items-start gap-3 rounded-lg border border-zinc-800 bg-zinc-950/20 p-3 text-sm text-zinc-200 transition-all hover:bg-zinc-900">
              <input type="radio" name="exit-q-${qIdx}" value="${oIdx}" class="mt-1">
              <span>${opt}</span>
            </label>
          `).join('')}
        </div>
      </div>
    `).join('');

    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }

  function closeExitQuiz() {
    const modal = document.getElementById('exit-quiz-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }

  async function submitExitQuiz() {
    const mod = SYLLABUS[activeModuleIdx];
    const quiz = getExitQuiz(mod);

    const answers = quiz.map((_, qIdx) => {
      const selected = document.querySelector(`input[name="exit-q-${qIdx}"]:checked`);
      return selected ? Number(selected.value) : -1;
    });

    const feedbackEl = document.getElementById('exit-quiz-feedback');
    feedbackEl.classList.add('hidden');

    try {
      const response = await fetch(`/course/${COURSE_ID}/verify-module`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ moduleIndex: activeModuleIdx, answers })
      });

      const data = await response.json();
      if (!response.ok) throw new Error(data?.error || 'Failed to verify module mastery');

      if (data.passed) {
        completedModules = Number.isInteger(data.completed_modules) ? data.completed_modules : completedModules + 1;
        triggerConfetti();
        closeExitQuiz();
        renderMindMap();
        renderModulePanel(Math.min(completedModules, SYLLABUS.length - 1));
      } else {
        feedbackEl.classList.remove('hidden');
        feedbackEl.className = 'mt-5 rounded-xl border border-red-900 bg-red-950/30 p-4 text-sm text-red-200';
        feedbackEl.innerHTML = `
          <div class="font-semibold">Not yet ‚Äî try again.</div>
          <div class="mt-1">${data.feedbackText || 'Review the lesson and retry.'}</div>
        `;
      }
    } catch (err) {
      feedbackEl.classList.remove('hidden');
      feedbackEl.className = 'mt-5 rounded-xl border border-red-900 bg-red-950/30 p-4 text-sm text-red-200';
      feedbackEl.textContent = err.message || 'Failed to submit quiz.';
    }
  }

  // Voice / tutor chat (simplified)
  function setupVoiceInteraction() {
    const inputEl = document.getElementById('tutor-input');
    const micBtn = document.getElementById('mic-btn');
    const listeningBadge = document.getElementById('listening-badge');
    const unsupportedText = document.getElementById('voice-unsupported');

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const supportsSTT = typeof SpeechRecognition === 'function';

    if (!supportsSTT) {
      if (micBtn) micBtn.classList.add('hidden');
      if (unsupportedText) unsupportedText.classList.remove('hidden');
      return;
    }

    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.continuous = false;
    recognition.interimResults = false;

    let listening = false;

    recognition.addEventListener('result', (event) => {
      const transcript = event.results[0][0].transcript;
      inputEl.value = transcript;
      setTimeout(() => {
        if (inputEl.value.trim()) {
          document.getElementById('tutor-form').requestSubmit();
        }
      }, 250);
    });

    recognition.addEventListener('start', () => {
      listening = true;
      micBtn.classList.add('text-red-300');
      listeningBadge.classList.remove('hidden');
    });

    recognition.addEventListener('end', () => {
      listening = false;
      micBtn.classList.remove('text-red-300');
      listeningBadge.classList.add('hidden');
    });

    micBtn.addEventListener('click', () => {
      if (listening) {
        recognition.stop();
      } else {
        recognition.start();
      }
    });
  }

  function createTutorBubble(text, role) {
    const wrapper = document.createElement('div');
    wrapper.className = role === 'user' ? 'flex justify-end' : 'flex justify-start';

    const bubble = document.createElement('div');
    bubble.className =
      'max-w-[85%] rounded-lg border px-3 py-2 text-sm leading-relaxed ' +
      (role === 'user'
        ? 'border-zinc-700 bg-zinc-950/70 text-zinc-100'
        : 'border-zinc-800 bg-zinc-900/40 text-zinc-100');

    bubble.innerHTML = role === 'ai' ? marked.parse(text || '') : (text || '');

    wrapper.appendChild(bubble);
    return wrapper;
  }

  function setupTutorChat() {
    const form = document.getElementById('tutor-form');
    const input = document.getElementById('tutor-input');
    const messages = document.getElementById('tutor-messages');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const question = (input.value || '').trim();
      if (!question) return;

      messages.appendChild(createTutorBubble(question, 'user'));
      input.value = '';

      const pending = createTutorBubble('Thinking... ü§î', 'ai');
      messages.appendChild(pending);
      pending.scrollIntoView({ behavior: 'smooth', block: 'end' });

      try {
        const response = await fetch(`/course/${COURSE_ID}/tutor`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            question,
            lessonTopic: currentLesson ? currentLesson.title : '',
            lessonText: currentLesson ? document.getElementById('card-content').innerText : ''
          })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data?.error || 'Failed to get tutor response');

        pending.replaceWith(createTutorBubble(data.answer || '', 'ai'));
      } catch (err) {
        pending.replaceWith(createTutorBubble('Sorry ‚Äî I could not answer that. Please try again.', 'ai'));
        console.error(err);
      }
    });
  }

  renderMindMap();
  renderModulePanel(selectedModuleIndex);
  setupVoiceInteraction();
  setupTutorChat();
</script>
